<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script type="text/javascript" src="bower_components/sails.io.js/dist/sails.io.js"></script>
    <script type="text/javascript">
        io.sails.autoConnect = false;
        io.sails.rejectUnauthorized = false;

        var socket = io.sails.connect('https://player.me:443', {
            transports: ['websocket']
        });

        var logOnEvent = function(eventIdentity){
            console.log(eventIdentity, '...');
            socket.on(eventIdentity, function(){
                var args = Array.prototype.slice.call(arguments);
                args = [eventIdentity, '<<'].concat(args.length ? args : [undefined]);
                console.log.apply(console, args);
            });
        };
        var errOnEvent = function(eventIdentity){
            console.log(eventIdentity, '...');
            socket.on(eventIdentity, function(){
                var args = Array.prototype.slice.call(arguments);
                args = [eventIdentity, '<<'].concat(args.length ? args : [undefined]);
                console.error.apply(console, args);
            });
        };

        // Sails
        logOnEvent('connect');
        errOnEvent('error');
        logOnEvent('disconnect');
        logOnEvent('reconnect');
        logOnEvent('reconnect_attempt');
        logOnEvent('reconnecting');
        errOnEvent('reconnect_error');
        errOnEvent('reconnect_failed');

        // Player
        logOnEvent('test');
        logOnEvent('feed');
        logOnEvent('feed-new');
        logOnEvent('friend:online');
        logOnEvent('notifications:new');
        logOnEvent('notifications:mark_all_read');

        // ???
        logOnEvent("close");
        logOnEvent("heartbeat");
        logOnEvent("success");
        logOnEvent("data");
        logOnEvent("sails:parseError");
        logOnEvent("pjax:start");
        logOnEvent("pjax:complete");
        logOnEvent("click.pjax");
        logOnEvent("popstate.pjax");
        logOnEvent("layout");
        logOnEvent("layoutComplete");


        sendVerify(false, function(body, JWR){
            console.log('verify', '<<', {
                body: body,
                statusCode: JWR.statusCode,
                headers: JWR.headers
            });

            subscribeFeedNew();
            sendTest('ping');
        });


        function sendTest(message){
            var params = { message: message };
            console.log('test', '>>', params);
            socket.post('/test', params);
        }

        function sendVerify(oauthAccessToken, callback){
            var params = null;
            if (oauthAccessToken) params = { access_token: oauthAccessToken };
            console.log('verify', '>>', params);
            socket.post('/verify', params, callback);
        }

        function subscribeFeed(activityIds){
            if (!activityIds) activityIds = ['following', 'discover'];
            var params = { channel:'feed', key:activityIds };
            console.log('subscribe-feed', '>>', params);

            socket.post('/rooms', params, function(){
                console.log("subscribe-feed <<", arguments);
            });
        }
        function subscribeFeedNew(tabs){
            if (!tabs) tabs = ['following', 'discover'];
            var params = { channel:'feed-new', key:tabs };
            console.log('subscribe-feed', '>>', params);

            socket.post('/rooms', params, function(){
                console.log("subscribe-feed <<", arguments);
            });
        }
    </script>

</head>
<body>

</body>
</html>