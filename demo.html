<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PlayerMe Realtime Demo</title>

    <script type="text/javascript" src="dist/playerme.models.js"></script>
    <script type="text/javascript" src="dist/playerme.realtime.js"></script>

    <script type="text/javascript">
        var RealtimeService = PlayerMe.realtime.RealtimeService;
        var ActivityModel = PlayerMe.models.ActivityModel;
        var CommentModel = PlayerMe.models.CommentModel;

        var service = new RealtimeService();
        window.PlayerMeDemo = {service:service};

        /**
         * @type {Object.<int, ActivityModel>}
         */
        var activities = {};

        console.log("PlayerMe Realtime Demo", {
            PlayerMe: PlayerMe,
            PlayerMeDemo: PlayerMeDemo,
            service: service
        });

        var onReady = function(){
            console.log(">> subscribeToFeed");
            service.subscribeToFeed();

            var testText = "woo";
            console.log(">> postTest", testText);
            service.postTest(testText);
        };

        console.log(">> connect");
        service.connect('https://player.me:443');
        service.onConnect(function(){ console.log("<< connect"); });

        console.log(">> verify");
        service.verify(function(){
            console.log("<< verify", arguments);
            onReady();
        });

        service.onTest(function(payload){
            console.log('<< onTest', payload);
        });

        service.onFeedUpdate(function(payload){
            console.log('<< onFeedUpdate', payload);

            try {
                var activity = new ActivityModel(payload.activity);
                activities[activity.id] = activity;
                console.log('   ', activity);
            }catch(e){
                console.error('   ', 'activity', e);
            }

            console.log('>> subscribeToActivity', payload.activity.id);
            service.subscribeToActivity(payload.activity.id);
        });

        service.onActivityUpdate(function(payload){
            console.log('<< onActivityUpdate', payload);

            try {
                var activity = new ActivityModel(payload.activity);
                activities[activity.id] = activity;
                console.log('   ', activity);
            }catch(e){
                console.error('   ', 'activity', e);
            }

            try {
                var comment = null;
                if (payload.comment) {
                    comment = new CommentModel(payload.comment);
                    console.log('   ', comment);
                }
            }catch(e){
                console.error('   ', 'comment', e);
            }
        });

    </script>
</head>
<body>

</body>
</html>